---
layout: post
title: '一些基础网络知识'
date: 2020-04-09
author: ZZChaser
# cover: 'http://on2171g4d.bkt.clouddn.com/jekyll-banner.png'
tags: network
---

> 网络基础知识：网络体系结构、TCP

## 网络体系结构
&emsp;&emsp;五层体系结构（中和了`OSI`和`TCP/IP`）、还有`OSI`体系机构（7层）、`TCP/IP`体系结构（4层）。下面已五层体系结构来介绍

![网络体系结构](/assets/img/network_architecture.png '网络体系结构')

### 应用层
* 为用户的应用进程的通讯提供服务
* 应用层协议定义了交互的规则，如`HTTP`协议（支持万维网应用）、`SMTP`协议（支持电子邮件）...

### 传输层
&emsp;&emsp;负责向两台主机进程之间的通信提供通用的数据传输服务，传输层主要使用一下两种协议：
* `TCP`(Transmisson Control Protocol)：提供面向连接，可靠的传输服务
  1. 需要建立连接
  2. 一条`TCP `连接只能有两个端点，端对端
  3. 可靠的交付：不丢失、不重复、无差错，一般用于传输文件，邮件等
  4. 全双工通讯，两端是进程都能主动发送数据
  5. 以字节流传输
* `UDP`(User Datagram Protocol)：提供无连接，不可靠的传输服务
  1. 无需建立连接
  2. 最大努力交付（速度快）但不可靠，一般用于即时通讯（QQ语音、直播等）
  3. 支持一对一、一对多、多对多通讯
  4. 首部小开销小8字节，`tcp`首部至少20字节
  5. 以数据报文段传输

### 网络层
&emsp;&emsp;负责为分组交换网上的不同主机提供通信服务
* 封装数据组/包进行传输
* 路由选择
* 逻辑寻址

### 链路层
* 封装数据成帧进行传输
* 物理寻址

### 物理层
* 把数据装换为比特进行传输，实现相邻计算机节点之间比特流的透明传送

## TCP（以下示例由发起方为客户端作为演示）

### 三次握手

#### 握手的目的
&emsp;&emsp;`TCP`目的是实现可靠传输，因此需要知道对方是否已收到自己发送的数据，于是引用了序号（`sequence number`）和确认号（`acknowledgement number`）来保障。发送方发送数据时需要同时发送`seq`，在接收方接收到数据后发送确认`ack`给发送方，于是发送方知道了自己发送的数据被对方接受到了

#### 三次握手的目的
* 三次握手就是双方发送初始序列号（`initial sequence number`），并确认对方收到的过程
  1. 客户端发起建立联机`syn = 1`，和初始序列号`sqe = x`发送到服务端
  2. 服务器收到，验证`syn = 1`后，发送确认`ack = 1`，`ack number = x + 1`，建立联机`syn = 1`和初始序列号`sqe = y`
  3. 客户端收到，确认无误后再发送确认`ack = 1`，`ack number = y + 1`

![三次握手](/assets/img/three_shakehands.png '三次握手')

* 防止脏连接。如果客户端发起的第一个联机请求再某个网络节点滞留，客户端由于在超时时间后没有收到确认，于是重发联机请求。传输数据释放后，第一个滞留的连接又发送到了服务端，于是导致脏连接。第三次握手就能防止这种情况，因为需要客户端的确认才能建立连接

### 四次挥手

#### 四次挥手的目的
* 确保双方的数据都完全发送并且被对方接受
  1. 客户端发送完数据，发起释放连接请求`fin = 1`，`seq = x`，客服端进入`fin_wait_1`状态（半关闭）
  2. 服务端收到发送确认`ack = 1`, `ack number = x + 1`，客户端进入`fin_wait_2`状态
  3. 服务器发送完数据后发起释放连接请求`fin = 1`，`seq = y`
  4. 客户端收到发送确认`ack = 1`，`ack number = y + 1`，客户端进入`time_wait`状态

#### 注意点
* 在第一次挥手后，客户端进入半关闭状态，就是不能再主动发送数据（除了确认报文）只能被动接受
* 在第四次挥手后，客户端进入`time_wait`状态，会等待`2MSL`(`Maximum Segment Lifetime`，TCP报文在传输过程中的最大生命周期)时间。期间如果没有收到服务端重传的释放连接请求，代表服务端收到了确认信息，就进入`closed`状态。如果服务端重发了释放请求，就再发送确认，重置计时器。。。

### 知识补充
1. 半连接队列与全连接队列（队列满了就会出现丢包现象）
   * 半连接：在收到客服端的`syn`联机请求后，连接处于`syn_rcvd`状态，服务器会把该状态的连接放入半连接队列中
   * 全连接：完成三次握手建立起的连接，就会放入全连接队列
2. `SYN`攻击
   攻击者伪造大量ip不存在的联机请求，导致服务器发送确认后得不到回复，于是重发确认直至超时，造成网络瘫痪，如果半连接满了还会丢失正常的联机请求。解决：网关过滤、减少超时、增大半连接队列
3. 三次握手中能携带数据吗
   如果第一次可以携带就会放大syn攻击，第三次代表能成功建立连接，可以携带数据



### 滑动窗口
&emsp;&emsp;滑动窗口是传输层流控的一种措施，接收方通告自己接收的窗口大小，发送方通过该值来调整发送的速度，从而防止发送方过快导致接收方被淹没

#### 发送窗口
&emsp;&emsp;大小等于对方通告的接受窗口大小，发送方的数据分为四类：
1. 已发送，已确认（收到ack确认）
2. 已发送，未确认
3. 未发送，接收方允许发送
4. 未发送，接收方未允许发送

其中`2, 3`部分的数据称为发送窗口
#### 接受窗口
&emsp;&emsp;大小由应用、系统、硬件限制，发送方的数据分为三类：
1. 已接收
2. 未接受，准备接受
3. 未接受，不准备接受

其中`2`部分称为接受窗口
#### 图片说明
![滑动窗口](/assets/img/slide_window.png '滑动窗口')

## HTTP缓存
&emsp;&emsp;缓存是用来减少请求，或减少请求响应的体积，从而达到减轻服务器压力和增强用户体验
### 缓存的位置
#### memory cache
* 缓存在内存中
* 空间较小
* 短期缓存（关掉tab就会释放掉）
* 忽略`http`头部设置`max-age: 0、no-cache`等，只要缓存存在就返回，除了`cache-control: no-store`

#### disk cache
* 缓存在硬盘中
* 空间较大
* 较长时间的缓存
* 允许相同的资源在跨会话，甚至跨站点的情况下使用
* 根据`http`头部信息进行设置

### 缓存类型
#### 强缓存
&emsp;&emsp;发起请求后，检查缓存中是否有相应缓存，如果有直接返回，不请求真正的服务器
#### 设置强缓存

* `Expires`（http1.0）
  
  `Expires: Tue Apr, 14 2020 09:51:16 GMT`：绝对时间。当浏览器时间和服务器时间不一致时可能导致缓存失效

* `Cache-control`（http1.1，优先级更高）
   
   * `max-age=86400`：相对时间。最大有效时间（单位`s`）
   * `must-revalidate`：超过最大时间，必须向服务器发起请求，验证资源是否有效
   * `no-cache`（http1.1之前可用`Pragma: no-cache`）：先缓存，使用前由协商缓存验证决定
   * `no-store`：不缓存，包括强制缓存和协商缓存，所有内容都请求服务器
   * `public`：客户端和代理服务器等都能缓存
   * `private`：只有客户端能缓存（默认值）

#### 协商缓存
&emsp;&emsp;发起请求时会带上服务器之前返回的标识，服务器根据标识判断缓存是否失效，未失效则返回`304`，继续使用缓存，反之则返回最新数据以及标识
#### 设置协商缓存
1. `Last-Modified`和`Last-Modified-Since`
   
   浏览器第一次请求的时候服务器设置`Last-Modified: Tue Apr, 14 2020 09:51:16 GMT`，告诉客户端资源的最后一次修改时间。当浏览器再次请求的时候会把`Last-Modified`值写进`Last-Modified-Since`一起发送给服务器。服务器将最新修改时间与`Last-Modified-Since`进行对比，相同则没有改变，返回`304`，反之返回最新数据以及最新修改时间。有如下缺陷
   * 但是但文件是动态生成的话，最新修改时间就是每次生成的时间，在文件内容没有改变的情况下达不到缓存的目的
2. `Etag`和`If-None-Match`
   
   流程与`Last-Modified`流程一样，只是`Etag`存的是文件的特殊标识（一般hash生成）。优先级比`Etag`高
## 参考

* <a style='color:#0A497B' href='https://juejin.im/post/5b5f20686fb9a04f844adbdd' target='_blank'>搞定计算机网络面试，看这篇就够了</a>
* <a style='color:#0A497B' href='https://blog.csdn.net/lengxiao1993/article/details/82771768' target='_blank'>TCP 为什么三次握手而不是两次握手</a>
* <a style='color:#0A497B' href='https://coolshell.cn/articles/11609.html' target='_blank'>TCP 的那些事儿（下）</a>
* <a style='color:#0A497B' href='https://zhuanlan.zhihu.com/p/44789005' target='_blank'>一文读懂前端缓存</a>

